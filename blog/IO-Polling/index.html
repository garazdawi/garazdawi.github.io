<!DOCTYPE html><html><head><meta charSet="utf-8"/><title>Erlang Programming Language</title><meta http-equiv="Content-Type" content="text/html;charset=utf-8"/><meta name="description" content="Erlang Programming Language"/><meta name="keywords" content="erlang, functional, programming, fault-tolerant, distributed, multi-platform, portable, software, multi-core, smp, concurrency"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link rel="alternate" type="application/rss+xml" title="Overall RSS 2.0 Feed" href="/rss"/><link rel="alternate" type="application/rss+xml" title="News RSS 2.0 Feed" href="/rss/news"/><link rel="alternate" type="application/rss+xml" title="Article RSS 2.0 Feed" href="/rss/articles"/><link rel="alternate" type="application/rss+xml" title="Events RSS 2.0 Feed" href="/rss/event"/><link rel="alternate" type="application/rss+xml" title="Downloads RSS 2.0 Feed" href="/rss/download"/><script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script><script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><link rel="preload" href="/_next/static/css/f91c265ba4ec340e076d.css" as="style"/><link rel="stylesheet" href="/_next/static/css/f91c265ba4ec340e076d.css" data-n-g=""/><noscript data-n-css="true"></noscript><link rel="preload" href="/_next/static/chunks/main-a9a86200c2afaf3f233a.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.9707fddd9ae5927c17c3.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.8b4ad2366e12f882e3d5.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-79f3144d8877c67ce98b.js" as="script"/><link rel="preload" href="/_next/static/chunks/9f96d65d.6d2fb2f6923d41a412a8.js" as="script"/><link rel="preload" href="/_next/static/chunks/87b308f4a72b1b263da2fe072492c20d1199252a.8368050723e578161621.js" as="script"/><link rel="preload" href="/_next/static/chunks/2968c2e854f156f56dcf4f3a0f05db49ee39d399.938502fc97c89e1a18f7.js" as="script"/><link rel="preload" href="/_next/static/chunks/a9595808cf5ee3285d96b2a14ee913304b9362ca.20c663042d024f8cc93c.js" as="script"/><link rel="preload" href="/_next/static/chunks/202314b546da1167b19f69946a64c65ef91ce335.8b78b06e27cf5f3f1fd9.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/blog/%5Bblog%5D-68965b4ff10aaca11026.js" as="script"/></head><body><div id="__next"><div class="navbar" style="background-color:#FFF;margin-bottom:0px"><div class="container"><button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-responsive-collapse" style="position:absolute;right:5px;margin-bottom:0px"><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a class="navbar-brand" href="/"><img src="/img/erlang.png" width="60"/></a><div class="nav-collapse collapse navbar-responsive-collapse" style="padding:20px"><ul class="nav navbar-nav"><li><a class="menu-headlines" href="/downloads/"> DOWNLOADS </a></li><li><a class="menu-headlines" href="/docs/"> DOCUMENTATION </a></li><li><a class="menu-headlines" href="/community/"> COMMUNITY </a></li><li><a class="menu-headlines" href="/news/"> NEWS </a></li><li><a class="menu-headlines" href="/eeps/"> EEPS </a></li><li><a class="menu-headlines" href="/blog/"> BLOG </a></li><li><a class="menu-headlines" href="/about/"> ABOUT </a></li></ul></div></div></div><div class="container"><div class="row"><div class="col-lg-12"><div class="divider"><p></p></div></div><div class="col-lg-12"><h3 class="sub-headlines"><img src="/img/news.png"/><span style="position:relative;top:5px;left:20px">NEWS</span></h3></div><div class="col-lg-2"><p></p></div><div class="col-lg-8"><div class="inside-cols"><h3><a href="/blog/IO-Polling/">I/O polling options in OTP 21</a></h3><p><em>Wednesday, 11 April 2018<!-- --> - <!-- -->Lukas Larsson</em></p><p>Erlang/OTP 21 will introduce a completely new IO polling implementation.
This new implementation comes with a new set of tuneable parameters that
can be used to get the most out of your system. This blog post describes
the parameters and attempts to describe what they should be used for.</p><p>The I/O polling framework in erts is responsible for delivering events to
ports and processes that have subscribed to events on file descriptors.
Before OTP 21 it was the job of an Erlang scheduler thread to deliver these
events. In OTP 21 dedicated threads are used to deliver the events.</p><p>For information about how the new implementation works under the hood you can
look at Kenneth Lundin&#x27;s presentation <a href="http://www.erlang-factory.com/euc2017/kenneth-lundin">Erlang VM News Regarding Dirty Schedulers and I/O</a>
from the EUC 2017.</p><h2>Kernel-space vs User-space polling</h2><p>In OTP 21 the <code>+K</code> option has been removed as it is not longer possible to
choose whether to use kernel-space poll or not at run-time. Instead the decision
is made at compile time where kernel-space poll will be used by default. If you
want to use user-space poll instead you have to pass the <code>--disable-kernel-poll</code>
flag to configure when compiling Erlang/OTP.</p><p>Before OTP 21 it made sense to run using user-space polling if the file
descriptors that was subscribed to tended to be removed quickly. For example
if a HTTP server managed short-lived connection from only a handful other
machines, it could be beneficial to use user-space poll. However if the
connection start being long-lived, or the number of concurrent connection
go up, kernel-space poll becomes better.</p><p>In OTP 21, this is no longer true. Because the polling has been moved to another
thread, it is almost always better to use kernel-space polling. The user-space
polling implementation is left in place for platforms that do not support
parallel update of the kernel-space pollset. Also user-space polling is used
for individual file descriptors when they cannot be put in a kernel-space pollset
for some reason.</p><h2>Poll-threads and Poll-sets</h2><p>OTP 21 introduces two new configuration parameters: +IOt and +IOp.</p><h3>Configure +IOt</h3><p>+IOt controls the number of threads that are used to deliver events. The default
is 1 and it should be enough for most applications. However on very busy
systems with many concurrent connection it could be beneficial to increase this.
One way to get an indication of whether your system could benefit from it is
by using <a href="http://erlang.org/doc/man/msacc.html">msacc</a>. If you turn it on briefly
and when examining the <code>msacc:print()</code> output notice that sleep time
of the the thread type <code>poll</code> is low, the system may benefit from increasing the
number of polling threads.</p><pre><code>Eshell V9.3  (abort with ^G)
1&gt; msacc:start(10000),msacc:print().
Average thread real-time    : 10000410 us
Accumulated system run-time :      937 us
Average scheduler run-time  :      897 us

        Thread      aux check_io emulator       gc    other     port    sleep

Stats per thread:
     async( 0)    0.00%    0.00%    0.00%    0.00%    0.00%    0.00%  100.00%
       aux( 1)    0.00%    0.00%    0.00%    0.00%    0.00%    0.00%  100.00%
dirty_cpu_( 1)    0.00%    0.00%    0.00%    0.00%    0.00%    0.00%  100.00%
dirty_io_s( 1)    0.00%    0.00%    0.00%    0.00%    0.00%    0.00%  100.00%
      poll( 0)    0.00%    0.00%    0.00%    0.00%    0.00%    0.00%  100.00%
 scheduler( 1)    0.00%    0.00%    0.00%    0.00%    0.01%    0.00%   99.99%

Stats per type:
         async    0.00%    0.00%    0.00%    0.00%    0.00%    0.00%  100.00%
           aux    0.00%    0.00%    0.00%    0.00%    0.00%    0.00%  100.00%
dirty_cpu_sche    0.00%    0.00%    0.00%    0.00%    0.00%    0.00%  100.00%
dirty_io_sched    0.00%    0.00%    0.00%    0.00%    0.00%    0.00%  100.00%
          poll    0.00%    0.00%    0.00%    0.00%    0.00%    0.00%  100.00%
     scheduler    0.00%    0.00%    0.00%    0.00%    0.01%    0.00%   99.99%</code></pre><p>In the example above the poll thread is sleeping for 100% of the time so no need to
increase the number of poll threads.</p><h3>Configure +IOp</h3><p>+IOp controls the number of pollsets used to put the file descriptors in. This
options defaults to 1, and it should be very rare for any system to benefit
from changing this. The only time so far that I have seen it to be beneficial is when the
kernel-space poll implementation does not scale well when accessed in parallel
by multiple threads. So if you run <a href="http://man7.org/linux/man-pages/man1/perf-top.1.html">perf top</a>
(or something similar) on your system and notice that a lot of time is spent
locking the kernel-space pollset, it would be a good idea to increase the
number of pollsets used.</p></div></div><div class="col-lg-2"><p><a href="/rss/blog/"><img src="/img/rss-icon.png" width="64"/></a></p></div></div></div><div class="container"><div class="row"><div class="col-lg-12"><div class="divider"><p></p></div></div><div class="col-lg-12 text-center"><div class="col-lg-4"><a title="DOWNLOAD" href="/download.html"><img src="/img/download.png"/></a></div><div class="col-lg-4"><a href="http://www.github.com/erlang/otp/"><img src="/img/GitHub-Mark-32px.png"/></a></div><div class="col-lg-4"><a href="http://www.twitter.com/erlang_org/"><img src="/img/twitter.png" width="32"/></a></div></div><div class="col-lg-12"><div class="divider"><p></p></div></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"item":{"id":"IO-Polling","title":"I/O polling options in OTP 21","author":"Lukas Larsson","excerpt":"\nErlang/OTP 21 will introduce a completely new IO polling implementation.\nThis new implementation comes with a new set of tuneable parameters that\ncan be used to get the most out of your system. This blog post describes\nthe parameters and attempts to describe what they should be used for.","article_date":1523404800000,"tags":["erts","polling","tcp"],"frontmatter":{"layout":"post","title":"I/O polling options in OTP 21","tags":"erts polling tcp","author":"Lukas Larsson"},"content":"\nErlang/OTP 21 will introduce a completely new IO polling implementation.\nThis new implementation comes with a new set of tuneable parameters that\ncan be used to get the most out of your system. This blog post describes\nthe parameters and attempts to describe what they should be used for.\n\nThe I/O polling framework in erts is responsible for delivering events to\nports and processes that have subscribed to events on file descriptors.\nBefore OTP 21 it was the job of an Erlang scheduler thread to deliver these\nevents. In OTP 21 dedicated threads are used to deliver the events.\n\nFor information about how the new implementation works under the hood you can\nlook at Kenneth Lundin's presentation [Erlang VM News Regarding Dirty Schedulers and I/O](http://www.erlang-factory.com/euc2017/kenneth-lundin)\nfrom the EUC 2017.\n\n## Kernel-space vs User-space polling\n\nIn OTP 21 the `+K` option has been removed as it is not longer possible to\nchoose whether to use kernel-space poll or not at run-time. Instead the decision\nis made at compile time where kernel-space poll will be used by default. If you\nwant to use user-space poll instead you have to pass the `--disable-kernel-poll`\nflag to configure when compiling Erlang/OTP.\n\nBefore OTP 21 it made sense to run using user-space polling if the file\ndescriptors that was subscribed to tended to be removed quickly. For example\nif a HTTP server managed short-lived connection from only a handful other\nmachines, it could be beneficial to use user-space poll. However if the\nconnection start being long-lived, or the number of concurrent connection\ngo up, kernel-space poll becomes better.\n\nIn OTP 21, this is no longer true. Because the polling has been moved to another\nthread, it is almost always better to use kernel-space polling. The user-space\npolling implementation is left in place for platforms that do not support\nparallel update of the kernel-space pollset. Also user-space polling is used\nfor individual file descriptors when they cannot be put in a kernel-space pollset\nfor some reason.\n\n## Poll-threads and Poll-sets\n\nOTP 21 introduces two new configuration parameters: +IOt and +IOp.\n\n### Configure +IOt\n\n+IOt controls the number of threads that are used to deliver events. The default\nis 1 and it should be enough for most applications. However on very busy\nsystems with many concurrent connection it could be beneficial to increase this.\nOne way to get an indication of whether your system could benefit from it is\nby using [msacc](http://erlang.org/doc/man/msacc.html). If you turn it on briefly\nand when examining the `msacc:print()` output notice that sleep time\nof the the thread type `poll` is low, the system may benefit from increasing the\nnumber of polling threads.\n\n```\nEshell V9.3  (abort with ^G)\n1\u003e msacc:start(10000),msacc:print().\nAverage thread real-time    : 10000410 us\nAccumulated system run-time :      937 us\nAverage scheduler run-time  :      897 us\n\n        Thread      aux check_io emulator       gc    other     port    sleep\n\nStats per thread:\n     async( 0)    0.00%    0.00%    0.00%    0.00%    0.00%    0.00%  100.00%\n       aux( 1)    0.00%    0.00%    0.00%    0.00%    0.00%    0.00%  100.00%\ndirty_cpu_( 1)    0.00%    0.00%    0.00%    0.00%    0.00%    0.00%  100.00%\ndirty_io_s( 1)    0.00%    0.00%    0.00%    0.00%    0.00%    0.00%  100.00%\n      poll( 0)    0.00%    0.00%    0.00%    0.00%    0.00%    0.00%  100.00%\n scheduler( 1)    0.00%    0.00%    0.00%    0.00%    0.01%    0.00%   99.99%\n\nStats per type:\n         async    0.00%    0.00%    0.00%    0.00%    0.00%    0.00%  100.00%\n           aux    0.00%    0.00%    0.00%    0.00%    0.00%    0.00%  100.00%\ndirty_cpu_sche    0.00%    0.00%    0.00%    0.00%    0.00%    0.00%  100.00%\ndirty_io_sched    0.00%    0.00%    0.00%    0.00%    0.00%    0.00%  100.00%\n          poll    0.00%    0.00%    0.00%    0.00%    0.00%    0.00%  100.00%\n     scheduler    0.00%    0.00%    0.00%    0.00%    0.01%    0.00%   99.99%\n```\n\nIn the example above the poll thread is sleeping for 100% of the time so no need to\nincrease the number of poll threads.\n\n### Configure +IOp\n\n+IOp controls the number of pollsets used to put the file descriptors in. This\noptions defaults to 1, and it should be very rare for any system to benefit\nfrom changing this. The only time so far that I have seen it to be beneficial is when the\nkernel-space poll implementation does not scale well when accessed in parallel\nby multiple threads. So if you run [perf top](http://man7.org/linux/man-pages/man1/perf-top.1.html)\n(or something similar) on your system and notice that a lot of time is spent\nlocking the kernel-space pollset, it would be a good idea to increase the\nnumber of pollsets used.\n"}},"__N_SSG":true},"page":"/blog/[blog]","query":{"blog":"IO-Polling"},"buildId":"6JjQqocIWQ_TWFupI_6kC","nextExport":false,"isFallback":false,"gsp":true,"head":[["meta",{"charSet":"utf-8"}],["title",{"children":"Erlang Programming Language"}],["meta",{"httpEquiv":"Content-Type","content":"text/html;charset=utf-8"}],["meta",{"name":"description","content":"Erlang Programming Language"}],["meta",{"name":"keywords","content":"erlang, functional, programming, fault-tolerant, distributed, multi-platform, portable, software, multi-core, smp, concurrency"}],["meta",{"name":"viewport","content":"width=device-width, initial-scale=1.0"}],["link",{"rel":"alternate","type":"application/rss+xml","title":"Overall RSS 2.0 Feed","href":"/rss"}],["link",{"rel":"alternate","type":"application/rss+xml","title":"News RSS 2.0 Feed","href":"/rss/news"}],["link",{"rel":"alternate","type":"application/rss+xml","title":"Article RSS 2.0 Feed","href":"/rss/articles"}],["link",{"rel":"alternate","type":"application/rss+xml","title":"Events RSS 2.0 Feed","href":"/rss/event"}],["link",{"rel":"alternate","type":"application/rss+xml","title":"Downloads RSS 2.0 Feed","href":"/rss/download"}],["script",{"src":"https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"}],["script",{"src":"https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js","integrity":"sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa","crossOrigin":"anonymous"}]]}</script><script nomodule="" src="/_next/static/chunks/polyfills-8bebc7aacc0076174a73.js"></script><script src="/_next/static/chunks/main-a9a86200c2afaf3f233a.js" async=""></script><script src="/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" async=""></script><script src="/_next/static/chunks/framework.9707fddd9ae5927c17c3.js" async=""></script><script src="/_next/static/chunks/commons.8b4ad2366e12f882e3d5.js" async=""></script><script src="/_next/static/chunks/pages/_app-79f3144d8877c67ce98b.js" async=""></script><script src="/_next/static/chunks/9f96d65d.6d2fb2f6923d41a412a8.js" async=""></script><script src="/_next/static/chunks/87b308f4a72b1b263da2fe072492c20d1199252a.8368050723e578161621.js" async=""></script><script src="/_next/static/chunks/2968c2e854f156f56dcf4f3a0f05db49ee39d399.938502fc97c89e1a18f7.js" async=""></script><script src="/_next/static/chunks/a9595808cf5ee3285d96b2a14ee913304b9362ca.20c663042d024f8cc93c.js" async=""></script><script src="/_next/static/chunks/202314b546da1167b19f69946a64c65ef91ce335.8b78b06e27cf5f3f1fd9.js" async=""></script><script src="/_next/static/chunks/pages/blog/%5Bblog%5D-68965b4ff10aaca11026.js" async=""></script><script src="/_next/static/6JjQqocIWQ_TWFupI_6kC/_buildManifest.js" async=""></script><script src="/_next/static/6JjQqocIWQ_TWFupI_6kC/_ssgManifest.js" async=""></script></body></html>