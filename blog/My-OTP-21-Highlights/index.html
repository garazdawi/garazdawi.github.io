<!DOCTYPE html><html><head><meta charSet="utf-8"/><title>Erlang Programming Language</title><meta http-equiv="Content-Type" content="text/html;charset=utf-8"/><meta name="description" content="Erlang Programming Language"/><meta name="keywords" content="erlang, functional, programming, fault-tolerant, distributed, multi-platform, portable, software, multi-core, smp, concurrency"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link rel="alternate" type="application/rss+xml" title="Overall RSS 2.0 Feed" href="/rss"/><link rel="alternate" type="application/rss+xml" title="News RSS 2.0 Feed" href="/rss/news"/><link rel="alternate" type="application/rss+xml" title="Article RSS 2.0 Feed" href="/rss/articles"/><link rel="alternate" type="application/rss+xml" title="Events RSS 2.0 Feed" href="/rss/event"/><link rel="alternate" type="application/rss+xml" title="Downloads RSS 2.0 Feed" href="/rss/download"/><script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script><script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><link rel="preload" href="/_next/static/css/4ee9685e1cc0da7f69f0.css" as="style"/><link rel="stylesheet" href="/_next/static/css/4ee9685e1cc0da7f69f0.css" data-n-g=""/><noscript data-n-css="true"></noscript><link rel="preload" href="/_next/static/chunks/main-a9a86200c2afaf3f233a.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.9707fddd9ae5927c17c3.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.8b4ad2366e12f882e3d5.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-290342a5f5c41b7caf9d.js" as="script"/><link rel="preload" href="/_next/static/chunks/9f96d65d.6d2fb2f6923d41a412a8.js" as="script"/><link rel="preload" href="/_next/static/chunks/87b308f4a72b1b263da2fe072492c20d1199252a.8368050723e578161621.js" as="script"/><link rel="preload" href="/_next/static/chunks/2968c2e854f156f56dcf4f3a0f05db49ee39d399.938502fc97c89e1a18f7.js" as="script"/><link rel="preload" href="/_next/static/chunks/a9595808cf5ee3285d96b2a14ee913304b9362ca.20c663042d024f8cc93c.js" as="script"/><link rel="preload" href="/_next/static/chunks/202314b546da1167b19f69946a64c65ef91ce335.8b78b06e27cf5f3f1fd9.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/blog/%5Bblog%5D-68965b4ff10aaca11026.js" as="script"/></head><body><div id="__next"><div class="navbar" style="background-color:#FFF;margin-bottom:0px"><div class="container"><button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-responsive-collapse" style="position:absolute;right:5px;margin-bottom:0px"><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a class="navbar-brand" href="/"><img src="/img/erlang.png" width="60"/></a><div class="nav-collapse collapse navbar-responsive-collapse" style="padding:20px"><ul class="nav navbar-nav"><li><a class="menu-headlines" href="/downloads/"> DOWNLOADS </a></li><li><a class="menu-headlines" href="/docs/"> DOCUMENTATION </a></li><li><a class="menu-headlines" href="/community/"> COMMUNITY </a></li><li><a class="menu-headlines" href="/news/"> NEWS </a></li><li><a class="menu-headlines" href="/eeps/"> EEPS </a></li><li><a class="menu-headlines" href="/blog/"> BLOG </a></li><li><a class="menu-headlines" href="/about/"> ABOUT </a></li></ul></div></div></div><div class="container"><div class="row"><div class="col-lg-12"><div class="divider"><p></p></div></div><div class="col-lg-12"><h3 class="sub-headlines"><img src="/img/news.png"/><span style="position:relative;top:5px;left:20px">NEWS</span></h3></div><div class="col-lg-2"><p></p></div><div class="col-lg-8"><div class="inside-cols"><h3><a href="/blog/My-OTP-21-Highlights/">My OTP 21 Highlights</a></h3><p><em>Wednesday, 2 May 2018<!-- --> - <!-- -->Lukas Larsson</em></p><p>OTP-21 Release Candidate 1 has just been released. I thought that I would go
through the changes that I am the most excited about. Most likely this will
mostly mean features in erts and the core libraries as those are the
changes that I am the most familiar with.</p><p>You can download the readme describing the changes here: <a href="http://erlang.org/download/otp_src_21.0-rc1.readme">OTP 21-RC1 Readme</a>.
Or, as always, look at the release notes of the application you are interested in.
For instance here: <a href="http://erlang.org/doc/apps/erts/notes.html">OTP 21-RC1 Erts Release Notes</a>.</p><h1>Compiler / Interpreter</h1><p>Björn Gustavsson has been doing a lot of work with the compiler and interpreter
the last year while I have been sitting next to him cheering. The largest changes
is part of the OTP-14626 ticket. While working on the
<a href="https://www.youtube.com/watch?v=PtgD5WRzcy4">BEAMJIT</a> development
I&#x27;ve been looking a lot at the <a href="http://luajit.org/">luajit</a> project and what
Mike Pall has done both in the JIT but also in the interpreter. Inspired by
this and some other ideas that we got from the BEAMJIT project we decided it was time
to do a major overhaul of the way that the BEAM interpreter is created. Most of the
changes done boil down to decreasing the size of beam code in memory, thus making more
code fit in the L1/L3 caches and in extension making code run faster. We&#x27;ve
decreased the loaded code size by about 20% using our optimizations. This has
translated to about a 5% performance increase for most Erlang code
which is quite amazing. Me or Björn will most likely write more about exactly
what this has entailed in a future blogpost.</p><p>Another compiler change that has had quite a large impact (at least in our benchmarks)
is OTP-14505 contributed by José Valim in <a href="http://github.com/erlang/otp/pull/1080">PR 1080</a>.
The change makes the compiler re-write:</p><pre><code>example({ok, Val}) -&gt; {ok, Val}.</code></pre><p>to</p><pre><code>example({ok, Val} = Tuple) -&gt; Tuple.</code></pre><p>eliminating the extra creation of the tuple. As it turns out this is a quite
common pattern in Erlang code so this will be good for all programs.</p><p>An example of this performance gain can be seen in the estone benchmarks SUITE
below. OTP-14626 together with some other compiler and erts improvements have
increased the number of stones from 370000 in OTP-20.3 (the green line), to
400000 in OTP-21 (the blue line). So about 7.5%.</p><p><img src="../images/estone_otp21_benchmark.png" alt="Estone OTP-21 benchmark"/></p><h1>Erlang run-time system</h1><p>There are many changes in the run-time system.</p><h2>File handling</h2><p>All file IO has traditionally been handled through a port. In OTP-21 all of the
file IO has been rewritten to use nifs instead, OTP-14256. This was mainly done
in order to run file operation in the dirty IO schedulers. It also had the nice
side-effect of significantly increasing throughput of certain operations.</p><p><img src="../images/file_tiny_reads_otp21_benchmark.png" alt="File tiny reads OTP-21 benchmark"/></p><p>For instance in the tiny reads benchmark OTP-21 (the blue line) is about 2.8 times
faster than OTP-20.3 (the green line).</p><p>Also it is now possible to open device files using file:open, see OTP-11462.</p><h2>I/O Polling</h2><p>The entire underlying mechanism for checking for I/O on sockets has been rewritten
and optimized for modern OS kernel polling features. See OTP-14346 and
[I/O polling options in OTP 21]({{ site.baseurl }}/IO-Polling) for more details.</p><h2>Distribution</h2><p>It has always been possible to write your own distribution carrier if you want
to if, for instance, you wanted to use <a href="https://tools.ietf.org/html/rfc2549">RFC-2549</a>
to send your distributed Erlang messages. However you have had to implement it as
a linked-in driver. With the introduction of OTP-14459 you can now use a process
or port as the distribution carrier. So now you can use gen_pigeon instead of having
to call the boost equivalent.</p><p>The ability to use processes as distribution carriers is now used by the TLS
distribution. This allows us to not have to jump through several hoops as was done
before increasing the throughput of TLS distribution significantly.</p><h2>Process signals</h2><p>When running benchmarks using cowboy and hammering it with connections that
do not use keep-alive, one of the SMP scalability bottlenecks that pop up
is the link lock of the supervisor that supervises all the connections.
The reason why this lock pops up is because when you have a lot of linked
processes, the rb-tree in which the links are stored becomes very large so
the insertion and deletion time increases. In OTP-14589 this has been
changed so that all link and monitor requests now are sent as messages
for the receiving process to take care of. This means that the lock has been
completely removed. Now all signals (be they messages, links, monitors,
process_info, group_leader etc) are handled through the same queue.</p><p>In addition, OTP-14901 now makes it so that monitor + send signals
are merged into one signal. So the contention is reduced even further
for gen_server:call like functions.</p><p><img src="../images/genstress_otp21_benchmark.png" alt="GenStress OTP-21 benchmark"/></p><p>The performance difference is quite significant. The genstress benchmark
seen above OTP-21 (the blue line) has almost doubled in throughput
compared to OTP-20.3 (the green line).</p><h1>Logger</h1><p>OTP-13295 adds a completely new logging framework for Erlang/OTP. It is
inspired by the way that <a href="https://github.com/erlang-lager/lager">lager</a>,
the <a href="https://hexdocs.pm/logger/Logger.html">Elixir Logger</a> and the <a href="https://docs.python.org/3/howto/logging.html">Python
logger</a> works.
With logger the logging handlers can intercept the logging
call in the process that does the actual call instead of having to
wait for a message. This opens up all sorts of possibilities of early
rejection of log messages in case of an overload, see <a href="http://erlang.org/documentation/doc-10.0-rc1/lib/kernel-6.0/doc/html/logger_chapter.html#protecting-the-handler-from-overload">Logger User&#x27;s Guide</a>
for more details. The user can also add special purpose filters that are run
before the handler is invoked in order to silence or amend log messages in the system.</p><h1>Misc</h1><p>HiPE has finally been fixed by Magnus Lång to use the receive reference optimization
that beam has had for a long time, OTP-14785.</p><p>The ftp and tfpt parts of inets have been separated into their own applications
instead of being bundled, OTP-14113.</p><p>The rand module has seen a lot of work, adding new features. I&#x27;m not sure when or
how the difference is useful, but the theory around this is fascinating, OTP-13764.</p><p>The maps module now has an maps:iterator/0 and maps:next/1, OTP-14012.</p><p>io_lib:format/3 has been added to limit the output of the functions. This is especially
useful when building logging frameworks as you may get arbitrarily large terms to
format and may want to cut them in order to not overwhelm the system, OTP-14983.</p><p>As a final note, I&#x27;m not sure if anyone noticed, but as of OTP-20.3, processes that
are in the state GARBING when your system crashes now have stack traces in the
crash dump!!!</p></div></div><div class="col-lg-2"><p><a href="/rss/blog/"><img src="/img/rss-icon.png" width="64"/></a></p></div></div></div><div class="container"><div class="row"><div class="col-lg-12"><div class="divider"><p></p></div></div><div class="col-lg-12 text-center"><div class="col-lg-4"><a title="DOWNLOAD" href="/download.html"><img src="/img/download.png"/></a></div><div class="col-lg-4"><a href="http://www.github.com/erlang/otp/"><img src="/img/GitHub-Mark-32px.png"/></a></div><div class="col-lg-4"><a href="http://www.twitter.com/erlang_org/"><img src="/img/twitter.png" width="32"/></a></div></div><div class="col-lg-12"><div class="divider"><p></p></div></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"item":{"id":"My-OTP-21-Highlights","title":"My OTP 21 Highlights","author":"Lukas Larsson","excerpt":"\nOTP-21 Release Candidate 1 has just been released. I thought that I would go\nthrough the changes that I am the most excited about. Most likely this will\nmostly mean features in erts and the core libraries as those are the\nchanges that I am the most familiar with.","article_date":1525219200000,"tags":["otp","21","release"],"frontmatter":{"layout":"post","title":"My OTP 21 Highlights","tags":"otp 21 release","author":"Lukas Larsson"},"content":"\nOTP-21 Release Candidate 1 has just been released. I thought that I would go\nthrough the changes that I am the most excited about. Most likely this will\nmostly mean features in erts and the core libraries as those are the\nchanges that I am the most familiar with.\n\nYou can download the readme describing the changes here: [OTP 21-RC1 Readme](http://erlang.org/download/otp_src_21.0-rc1.readme).\nOr, as always, look at the release notes of the application you are interested in.\nFor instance here: [OTP 21-RC1 Erts Release Notes](http://erlang.org/doc/apps/erts/notes.html).\n\n# Compiler / Interpreter #\n\nBjörn Gustavsson has been doing a lot of work with the compiler and interpreter\nthe last year while I have been sitting next to him cheering. The largest changes\nis part of the OTP-14626 ticket. While working on the\n[BEAMJIT](https://www.youtube.com/watch?v=PtgD5WRzcy4) development\nI've been looking a lot at the [luajit](http://luajit.org/) project and what\nMike Pall has done both in the JIT but also in the interpreter. Inspired by\nthis and some other ideas that we got from the BEAMJIT project we decided it was time\nto do a major overhaul of the way that the BEAM interpreter is created. Most of the\nchanges done boil down to decreasing the size of beam code in memory, thus making more\ncode fit in the L1/L3 caches and in extension making code run faster. We've\ndecreased the loaded code size by about 20% using our optimizations. This has\ntranslated to about a 5% performance increase for most Erlang code\nwhich is quite amazing. Me or Björn will most likely write more about exactly\nwhat this has entailed in a future blogpost.\n\nAnother compiler change that has had quite a large impact (at least in our benchmarks)\nis OTP-14505 contributed by José Valim in [PR 1080](http://github.com/erlang/otp/pull/1080).\nThe change makes the compiler re-write:\n\n    example({ok, Val}) -\u003e {ok, Val}.\n\nto\n\n    example({ok, Val} = Tuple) -\u003e Tuple.\n\neliminating the extra creation of the tuple. As it turns out this is a quite\ncommon pattern in Erlang code so this will be good for all programs.\n\nAn example of this performance gain can be seen in the estone benchmarks SUITE\nbelow. OTP-14626 together with some other compiler and erts improvements have\nincreased the number of stones from 370000 in OTP-20.3 (the green line), to\n400000 in OTP-21 (the blue line). So about 7.5%.\n\n![Estone OTP-21 benchmark](../images/estone_otp21_benchmark.png)\n\n# Erlang run-time system #\n\nThere are many changes in the run-time system.\n\n## File handling ##\n\nAll file IO has traditionally been handled through a port. In OTP-21 all of the\nfile IO has been rewritten to use nifs instead, OTP-14256. This was mainly done\nin order to run file operation in the dirty IO schedulers. It also had the nice\nside-effect of significantly increasing throughput of certain operations.\n\n![File tiny reads OTP-21 benchmark](../images/file_tiny_reads_otp21_benchmark.png)\n\nFor instance in the tiny reads benchmark OTP-21 (the blue line) is about 2.8 times\nfaster than OTP-20.3 (the green line).\n\nAlso it is now possible to open device files using file:open, see OTP-11462.\n\n## I/O Polling ##\n\nThe entire underlying mechanism for checking for I/O on sockets has been rewritten\nand optimized for modern OS kernel polling features. See OTP-14346 and\n[I/O polling options in OTP 21]({{ site.baseurl }}/IO-Polling) for more details.\n\n## Distribution ##\n\nIt has always been possible to write your own distribution carrier if you want\nto if, for instance, you wanted to use [RFC-2549](https://tools.ietf.org/html/rfc2549)\nto send your distributed Erlang messages. However you have had to implement it as\na linked-in driver. With the introduction of OTP-14459 you can now use a process\nor port as the distribution carrier. So now you can use gen_pigeon instead of having\nto call the boost equivalent.\n\nThe ability to use processes as distribution carriers is now used by the TLS\ndistribution. This allows us to not have to jump through several hoops as was done\nbefore increasing the throughput of TLS distribution significantly.\n\n## Process signals ##\n\nWhen running benchmarks using cowboy and hammering it with connections that\ndo not use keep-alive, one of the SMP scalability bottlenecks that pop up\nis the link lock of the supervisor that supervises all the connections.\nThe reason why this lock pops up is because when you have a lot of linked\nprocesses, the rb-tree in which the links are stored becomes very large so\nthe insertion and deletion time increases. In OTP-14589 this has been\nchanged so that all link and monitor requests now are sent as messages\nfor the receiving process to take care of. This means that the lock has been\ncompletely removed. Now all signals (be they messages, links, monitors,\nprocess\\_info, group\\_leader etc) are handled through the same queue.\n\nIn addition, OTP-14901 now makes it so that monitor + send signals\nare merged into one signal. So the contention is reduced even further\nfor gen_server:call like functions.\n\n![GenStress OTP-21 benchmark](../images/genstress_otp21_benchmark.png)\n\nThe performance difference is quite significant. The genstress benchmark\nseen above OTP-21 (the blue line) has almost doubled in throughput\ncompared to OTP-20.3 (the green line).\n\n# Logger\n\nOTP-13295 adds a completely new logging framework for Erlang/OTP. It is\ninspired by the way that [lager](https://github.com/erlang-lager/lager),\nthe [Elixir Logger](https://hexdocs.pm/logger/Logger.html) and the [Python\nlogger](https://docs.python.org/3/howto/logging.html) works.\nWith logger the logging handlers can intercept the logging\ncall in the process that does the actual call instead of having to\nwait for a message. This opens up all sorts of possibilities of early\nrejection of log messages in case of an overload, see [Logger User's Guide](http://erlang.org/documentation/doc-10.0-rc1/lib/kernel-6.0/doc/html/logger_chapter.html#protecting-the-handler-from-overload)\nfor more details. The user can also add special purpose filters that are run\nbefore the handler is invoked in order to silence or amend log messages in the system.\n\n# Misc\n\nHiPE has finally been fixed by Magnus Lång to use the receive reference optimization\nthat beam has had for a long time, OTP-14785.\n\nThe ftp and tfpt parts of inets have been separated into their own applications\ninstead of being bundled, OTP-14113.\n\nThe rand module has seen a lot of work, adding new features. I'm not sure when or\nhow the difference is useful, but the theory around this is fascinating, OTP-13764.\n\nThe maps module now has an maps:iterator/0 and maps:next/1, OTP-14012.\n\nio_lib:format/3 has been added to limit the output of the functions. This is especially\nuseful when building logging frameworks as you may get arbitrarily large terms to\nformat and may want to cut them in order to not overwhelm the system, OTP-14983.\n\nAs a final note, I'm not sure if anyone noticed, but as of OTP-20.3, processes that\nare in the state GARBING when your system crashes now have stack traces in the\ncrash dump!!!\n"}},"__N_SSG":true},"page":"/blog/[blog]","query":{"blog":"My-OTP-21-Highlights"},"buildId":"92Ploa_JRk4A9mAiRpquq","nextExport":false,"isFallback":false,"gsp":true,"head":[["meta",{"charSet":"utf-8"}],["title",{"children":"Erlang Programming Language"}],["meta",{"httpEquiv":"Content-Type","content":"text/html;charset=utf-8"}],["meta",{"name":"description","content":"Erlang Programming Language"}],["meta",{"name":"keywords","content":"erlang, functional, programming, fault-tolerant, distributed, multi-platform, portable, software, multi-core, smp, concurrency"}],["meta",{"name":"viewport","content":"width=device-width, initial-scale=1.0"}],["link",{"rel":"alternate","type":"application/rss+xml","title":"Overall RSS 2.0 Feed","href":"/rss"}],["link",{"rel":"alternate","type":"application/rss+xml","title":"News RSS 2.0 Feed","href":"/rss/news"}],["link",{"rel":"alternate","type":"application/rss+xml","title":"Article RSS 2.0 Feed","href":"/rss/articles"}],["link",{"rel":"alternate","type":"application/rss+xml","title":"Events RSS 2.0 Feed","href":"/rss/event"}],["link",{"rel":"alternate","type":"application/rss+xml","title":"Downloads RSS 2.0 Feed","href":"/rss/download"}],["script",{"src":"https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"}],["script",{"src":"https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js","integrity":"sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa","crossOrigin":"anonymous"}]]}</script><script nomodule="" src="/_next/static/chunks/polyfills-8bebc7aacc0076174a73.js"></script><script src="/_next/static/chunks/main-a9a86200c2afaf3f233a.js" async=""></script><script src="/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" async=""></script><script src="/_next/static/chunks/framework.9707fddd9ae5927c17c3.js" async=""></script><script src="/_next/static/chunks/commons.8b4ad2366e12f882e3d5.js" async=""></script><script src="/_next/static/chunks/pages/_app-290342a5f5c41b7caf9d.js" async=""></script><script src="/_next/static/chunks/9f96d65d.6d2fb2f6923d41a412a8.js" async=""></script><script src="/_next/static/chunks/87b308f4a72b1b263da2fe072492c20d1199252a.8368050723e578161621.js" async=""></script><script src="/_next/static/chunks/2968c2e854f156f56dcf4f3a0f05db49ee39d399.938502fc97c89e1a18f7.js" async=""></script><script src="/_next/static/chunks/a9595808cf5ee3285d96b2a14ee913304b9362ca.20c663042d024f8cc93c.js" async=""></script><script src="/_next/static/chunks/202314b546da1167b19f69946a64c65ef91ce335.8b78b06e27cf5f3f1fd9.js" async=""></script><script src="/_next/static/chunks/pages/blog/%5Bblog%5D-68965b4ff10aaca11026.js" async=""></script><script src="/_next/static/92Ploa_JRk4A9mAiRpquq/_buildManifest.js" async=""></script><script src="/_next/static/92Ploa_JRk4A9mAiRpquq/_ssgManifest.js" async=""></script></body></html>